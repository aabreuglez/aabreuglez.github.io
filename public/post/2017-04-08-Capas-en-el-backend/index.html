<!DOCTYPE html>
<html lang="es-ES">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no" />
  <title>Capas en el backend</title>
  <link href="http://adrianabreu.github.io/css/materialize.min.css" type="text/css" rel="stylesheet" media="screen,projection" />
  <link href="http://adrianabreu.github.io/css/style.css" type="text/css" rel="stylesheet" media="screen,projection" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/styles/default.min.css">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
</head>

<body>  <nav>
    <div id="top-nav" class="nav-wrapper">
        <a href="#" data-activates="mobile-demo" class="hide-on-med-and-up button-collapse"><i class="mdi-action-view-headline"></i></a>
        <ul class="hide-on-small-only">
            <li><a href="http://adrianabreu.github.io"><i class="mdi-action-home left"></i>Home</a></li>
            <li><a href="http://adrianabreu.github.io/post/"><i class="mdi-action-description left"></i>Blog</a></li>
            <li><a href="http://adrianabreu.github.io/projects/"><i class="mdi-action-pageview left"></i>Proyectos</a></li>
            <li><a href="http://adrianabreu.github.io/about/"><i class="mdi-action-account-circle left"></i>Contáctame</a></li>
        </ul>
        <ul class="side-nav" id="mobile-demo">
            <li><a href="http://adrianabreu.github.io"><i class="mdi-action-home left"></i>Home</a></li>
            <li><a href="http://adrianabreu.github.io/post/"><i class="mdi-action-description left"></i>Blog</a></li>
            <li><a href="http://adrianabreu.github.io/projects/"><i class="mdi-action-pageview left"></i>Proyectos</a></li>
            <li><a href="http://adrianabreu.github.io/about/"><i class="mdi-action-account-circle left"></i>Contáctame</a></li>
        </ul>
    </div>
</nav>
<div class="container">
    <div class="single-section">

        <div class="row">
            <div class="col s12">
                <h4>Capas en el backend</h4>
                <p>
                    
                </p>
                <p>8 Apr 2017 
                </p>
                <p>

<p>Una de las cosas más difíciles cuando ves un proyecto de backend por primera vez es discernir la funcionalidad y responsabilidad de las distintas capas. Así que me he planteado dar una visión general.</p>

<p>Antes de nada, quiero aclarar que es probable que esta nomenclatura no coincida con otra que veais por ahí, existen muchos sinónimos para los mismos conceptos, yo por mi parte, voy a explicar cual utilizo actualmente.</p>

<p>Por supuesto, todo estará ilustrado con un sencillo proyecto de ejemplo que he hecho para la ocasión. Así que, comencemos por el patrón DTO.</p>

<h2 id="data-transfer-object">Data Transfer Object</h2>

<p>Un DTO es un objeto que se utiliza en transferencias. Existen varios motivos para utilizar este tipo de objeto:</p>

<p>El motivo original es que con lo costoso que resulta abrir un canal de comunicación, debería traerse toda la información posible en esta para &ldquo;amortizarla&rdquo;.</p>

<p>No siempre es necesario mandar al front end todos los campos del backend. Quizás algunos campos sean de control, o quizás no necesitemos transferir todo el objeto.</p>

<pre><code>public class GreetingDTO {

	private Long id;
	
	private String message;

	
	public Long getId() {
		return id;
	}

	public void setId(Long id) {
		this.id = id;
	}

	public String getMessage() {
		return message;
	}

	public void setMessage(String message) {
		this.message = message;
	}	
}
</code></pre>

<h2 id="mapper">Mapper</h2>

<p>Para convertir las entidades en DTO y viceversa, utilizamos un mapper. Aquí un breve ejemplo. Nótese que lo he anotado como un componente de Spring con @Component.</p>

<pre><code>@Component
public class GreetingMapper {

	public GreetingDTO toDTO(Greeting source) {
		if (source == null) {
			return null;
		}
		
		GreetingDTO target = new GreetingDTO();
		target.setId(source.getId());
		target.setMessage(source.getMessage());
		return target;
	}
	
	public Greeting toEntity(GreetingDTO source) {
		if (source == null) {
			return null;
		}
		
		Greeting target = new Greeting();
		target.setId(source.getId());
		target.setMessage(source.getMessage());
		return target;
	}
	
	public List&lt;GreetingDTO&gt; toDTOList(List&lt;Greeting&gt; source) {
		if (source == null) {
			return null;
		}
		List&lt;GreetingDTO&gt; target = source.stream().map(greeting -&gt; toDTO(greeting)).collect(Collectors.toList());
		return target;	
	}
	
	public List&lt;Greeting&gt; toEntityList(List&lt;GreetingDTO&gt; source) {
		if (source == null) {
			return null;
		}
		List&lt;Greeting&gt; target = source.stream().map(greetingDTO -&gt; toEntity(greetingDTO)).collect(Collectors.toList());
		return target;
				
	}
}
</code></pre>

<h2 id="resource-controller">Resource / Controller</h2>

<p>Los controladores (denominados también recursos) van a ser los encargados de relacionar tal acción cuando ejecutemos X método HTTP (GET, POST, PUT, DELETE&hellip;) sobre Y ruta (/users, /greetings).</p>

<p>Es importante separar la lógica de negocio del controlador. Por lo general, un controlador solo debería llamar a los mapper y a los servicios que correspondan.</p>

<pre><code>@RequestMapping(&quot;/greetings&quot;)
@RestController
public class GreetingResource {

	@Autowired
	private GreetingService greetingService;
	
	@Autowired
	private GreetingMapper greetingMapper;
	
    @GetMapping(&quot;&quot;)
    public List&lt;GreetingDTO&gt; obtener() {
    	List&lt;Greeting&gt; greetings = greetingService.findAll();
    	List&lt;GreetingDTO&gt; greetingDTOs = greetingMapper.toDTOList(greetings);
    	return greetingDTOs;
    }
    
    
    @PostMapping(&quot;&quot;)
    public GreetingDTO crear(GreetingDTO greetingDTO) {
    	Greeting greeting = greetingMapper.toEntity(greetingDTO);
    	greeting = greetingService.save(greeting);
    	greetingDTO = greetingMapper.toDTO(greeting);
    	
    	return greetingDTO;
    }
    
    @GetMapping(&quot;/{id}&quot;)
    public GreetingDTO optenerPorId(@PathVariable(value=&quot;id&quot;) Long greetingId) {
    	Greeting greeting = greetingService.findOneById(greetingId);
    	GreetingDTO greetingDTO = greetingMapper.toDTO(greeting);
    	return greetingDTO;
    }
    
    @DeleteMapping(&quot;/{id}&quot;)
    public ResponseEntity borrar(@PathVariable(value=&quot;id&quot;) Long greetingId) {
    	greetingService.delete(greetingId);
    	return new ResponseEntity&lt;&gt;(HttpStatus.OK);
    }
    
}
</code></pre>

<h2 id="service">Service</h2>

<p>La capa de servicio es la capa que se encargará de gestionar la lógica de negocio y de &ldquo;enmascarar&rdquo; la capa de acceso a los datos.</p>

<pre><code>@Service
public class GreetingService {
	
	@Autowired
	private GreetingRepository greetingRepository;
	
	
	public List&lt;Greeting&gt; findAll() {
		return greetingRepository.findAll();
	}
	
	public Greeting findOneById(Long id) {
		return greetingRepository.findOneById(id);
	}
	
	public Greeting save(Greeting greeting) {
		// Usando la lógica de negocio modificamos los campos que solo nos interesan de la entidad
		greeting.setUpdated(Boolean.TRUE);
		return greetingRepository.save(greeting);
	}
	
	public void delete(Long id) {
		greetingRepository.delete(id);
	}
}
</code></pre>

<h2 id="repository">Repository</h2>

<p>La capa de repository se encargará de acceder a los datos. Para este ejemplo tan sencillo he utilizado como almacenamiento un HashMap.</p>

<pre><code>@Repository
public class GreetingRepository {

	private AtomicInteger idCounter = new AtomicInteger();
	private HashMap&lt;Long,Greeting&gt; greetings = new HashMap();
	
	public List&lt;Greeting&gt; findAll() {
		return new ArrayList&lt;Greeting&gt;(greetings.values());
	}
	
	public Greeting findOneById(Long id) {
		return greetings.get(id);
	}
	
	public Greeting save(Greeting greeting) {
		greeting.setId(idCounter.longValue());
		greetings.put(idCounter.longValue(), greeting);
		idCounter.incrementAndGet();
		return greeting;
	}
	
	public void delete(Long id) {
		greetings.remove(id);
	}
}
</code></pre>

<p>Para demostrar que el ejemplo funciona correctamente, haré algunas peticiones REST. Para esto, utilizo normalmente el cliente <a href="https://www.getpostman.com/">Postman</a>.</p>

<p>Primero, almacenaremos dos objetos.

<figure >
    
        <img src="/images/capas-backend/1.png" />
    
    
</figure>
</p>

<p>Después, recuperaremos la lista de objetos.

<figure >
    
        <img src="/images/capas-backend/2.png" />
    
    
</figure>
</p>

<p>Por último, borremos uno de ellos.

<figure >
    
        <img src="/images/capas-backend/3.png" />
    
    
</figure>
</p>

<p>Como vemos, las diferentes capas en la aplicación hacen una gran separación de responsabilidades. Dandonos una estructura clara y robusta.</p>

<p><a href="https://github.com/adrianabreu/spring-layers-example">Aquí tenéis el proyecto completo en Github</a>, para poder ver el código completo.</p>

<h2 id="bibliografía">Bibliografía</h2>

<ul>
<li><a href="https://martinfowler.com/eaaCatalog/dataTransferObject.html">https://martinfowler.com/eaaCatalog/dataTransferObject.html</a></li>
<li><a href="https://martinfowler.com/eaaCatalog/serviceLayer.html">https://martinfowler.com/eaaCatalog/serviceLayer.html</a></li>
<li><a href="https://martinfowler.com/eaaCatalog/applicationController.html">https://martinfowler.com/eaaCatalog/applicationController.html</a></li>
</ul>
</p>

            </div>
        </div>
        <div class="row">
            <div class="col s3 m1">
                
                <a class="btn-floating btn-large paginate-button" href="http://adrianabreu.github.io/post/2017-04-09-Docker/"><i class="mdi-navigation-arrow-back"></i></a>                
            </div>
            <div class="col s6 m10 center">&nbsp</div>
            <div class="col s3 m1">
                
                <a class="btn-floating btn-large paginate-button" href="http://adrianabreu.github.io/post/2017-03-24-Interaccion-a-traves-de-viewchild/"><i class="mdi-navigation-arrow-forward"></i></a>                
            </div>
        </div>
    </div>
</div>

<footer class="page-footer">
  <div class="footer-copyright">
    <div class="container">
      2017 Adrián Abreu
    </div>
  </div>
</footer>
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="http://adrianabreu.github.io/js/materialize.min.js"></script>
<script src="http://adrianabreu.github.io/js/init.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/highlight.min.js"></script>
<script>
  hljs.initHighlightingOnLoad();

</script>


</body>

</html>